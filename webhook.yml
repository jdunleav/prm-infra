version: 0.1

phases:
  install:
    commands:
      - sudo apt-get update
      - sudo apt-get install zip
      - sudo apt-get install openssh-client
  build:
    commands:      
      - git archive -o latest.zip HEAD
      - git rev-parse --short HEAD | xargs -I{} aws s3 cp latest.zip s3://prm-application-source/source-walking-skeleton-spikes/{}.zip
      - aws s3 cp latest.zip s3://prm-application-source/source-walking-skeleton-spikes/latest.zip
      - aws s3 sync s3://prm-application-source/id_rsa ~/.ssh/ --region eu-west-2
      - ls -l ~/.ssh/
      - eval "$(ssh-agent -s)"
      - ssh-add -K ~/.ssh/id_rsa
      - git push --mirror git@github.com:nhsconnect/prm-infra.git
