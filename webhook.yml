version: 0.1

phases:
  install:
    commands:
      - sudo apt-get update
      - sudo apt-get install zip
      - sudo apt-get install openssh-client
      - aws s3 cp s3://prm-application-source/id_rsa ~/.ssh/      
      - chmod 500 ~/.ssh/*_rsa 
      - ls -l ~/.ssh/
  build:
    commands:      
      - git archive -o latest.zip HEAD
      - git rev-parse --short HEAD | xargs -I{} aws s3 cp latest.zip s3://prm-application-source/source-walking-skeleton-spikes/{}.zip
      - aws s3 cp latest.zip s3://prm-application-source/source-walking-skeleton-spikes/latest.zip          
      - ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
      - ssh-add -K ~/.ssh/id_rsa
      - git push --mirror git@github.com:nhsconnect/prm-infra.git
