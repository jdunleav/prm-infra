version: 0.2

phases:
  install:
    commands:
      - sudo apt-get update
      - sudo apt-get install zip
      - sudo apt-get install unzip
      - wget https://releases.hashicorp.com/terraform/0.11.10/terraform_0.11.10_linux_amd64.zip
      - unzip terraform_0.11.10_linux_amd64.zip
      - sudo mv terraform /bin
      - sudo chmod +x /bin/terraform
      - wget https://github.com/gruntwork-io/terragrunt/releases/download/v0.17.3/terragrunt_linux_amd64
      - sudo mv terragrunt_linux_amd64 /bin/terragrunt
      - sudo chmod +x /bin/terragrunt
  pre_build:
    commands:
      # Workaround until TF supports creds via Task Roles when running on ECS or CodeBuild
      # See: https://github.com/hashicorp/terraform/issues/8746
      - export AWS_ACCESS_KEY_ID=`curl --silent http://169.254.170.2:80$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI | jq -r '.AccessKeyId'`
      - export AWS_SECRET_ACCESS_KEY=`curl --silent http://169.254.170.2:80$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI | jq -r '.SecretAccessKey'`
      - export AWS_SESSION_TOKEN=`curl --silent http://169.254.170.2:80$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI | jq -r '.Token'`      
  build:
    commands:
      - touch terraform.tfvars
      - terragrunt init --terragrunt-working-dir ./terragrunt/account/431593652018/common/codebuild
      - terragrunt validate --terragrunt-working-dir ./terragrunt/account/431593652018/common/codebuild
      - terragrunt plan --terragrunt-working-dir ./terragrunt/account/431593652018/common/codebuild
      - echo Lambdas building
      - terragrunt init --terragrunt-working-dir ./terragrunt/account/431593652018/dev/lambdas
      - terragrunt validate --terragrunt-working-dir ./terragrunt/account/431593652018/dev/lambdas
      - terragrunt plan --terragrunt-working-dir ./terragrunt/account/431593652018/dev/lambdas

