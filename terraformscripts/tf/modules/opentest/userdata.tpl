 #!/bin/bash -e

export OPENTEST_ENDPOINT=${OPENTEST_ENDPOINT}

yum -y update
yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
yum -y install openvpn nginx

echo '192.168.128.11 msg.opentest.hscic.gov.uk' >> /etc/hosts

aws s3 cp s3://${OPENTEST_ASSETS_BUCKET}/vpn-client-1318-10.0.225.80.tar vpn-client-1318-10.0.225.80.tar
aws s3 cp s3://${OPENTEST_ASSETS_BUCKET}/nginxconf/nginx.conf /etc/nginx/nginx.conf
aws s3 cp s3://${OPENTEST_ASSETS_BUCKET}/nginxconf/mesh.conf /etc/nginx/conf.d/mesh.conf
 

tar xvf vpn-client-1318-10.0.225.80.tar -C /etc/openvpn

sed -i "s/ELB_DNS/$OPENTEST_ENDPOINT/g" /etc/nginx/conf.d/mesh.conf

systemctl enable openvpn@vpn-client-1318-10.0.225.80.linux
systemctl start openvpn@vpn-client-1318-10.0.225.80.linux

systemctl enable nginx.service
systemctl start nginx.service

