import boto3

def lambda_handler(event, context):
    # Ensure the source/dest check attribute is False to enable instance to route traffic
    context.log("Setting source/dest check to False for instance " + event["detail"]["EC2InstanceId"] + "\n")

    ec2 = boto3.client('ec2')

    response = ec2.modify_instance_attribute(
        SourceDestCheck={
            'Value': False
        },
        InstanceId=event["detail"]["EC2InstanceId"]
    )

    context.log("Completed setting source/dest check to False for instance " + event["detail"]["EC2InstanceId"] + "\n")

    # Allow provisioning to continue...
    context.log("Completing autoscaling lifecycle action for instance " + event["detail"]["EC2InstanceId"] + "\n")

    autoscaling = boto3.client('autoscaling')

    autoscaling.complete_lifecycle_action(
        LifecycleHookName=event["detail"]["LifecycleHookName"],
        AutoScalingGroupName=event["detail"]["AutoScalingGroupName"],
        LifecycleActionToken=event["detail"]["LifecycleActionToken"],
        LifecycleActionResult="CONTINUE",
        InstanceId=event["detail"]["EC2InstanceId"]
    )

    context.log("Completed autoscaling lifecycle action for instance " + event["detail"]["EC2InstanceId"] + "\n")

    return "Success"